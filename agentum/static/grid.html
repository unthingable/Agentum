<html>
    <head>
        <title>Agentum runner</title>
        <script type="text/javascript" src="/jquery-1.4.3.min.js"></script>
        <script type="text/javascript">
        var ws;
        $(function() {
            // Open up a connection to our server
            // var url = "ws://192.168.3.137:9999/data";

            var loc = window.location, new_uri;
            if (loc.protocol === "https:") {
                new_uri = "wss:";
            } else {
                new_uri = "ws:";
            }
            new_uri += "//" + loc.host + "/data";
            // new_uri += loc.pathname + "/data";

            if ("MozWebSocket" in window) {
                ws = new MozWebSocket(new_uri);
            } else {
                ws = new WebSocket(new_uri);
            }

            // What do we do when we get a message?
            ws.onmessage = function(evt) {
                //$("#placeholder").append(evt.data + '\n');
                console.log(evt.data);
                handle_msg(evt.data);
            }
            // Just update our conn_status field with the connection status
            ws.onopen = function(evt) {
                $('#conn_status').html('<b>Connected</b>');
                //ws.send("step");
                //ws.send("quit")
            }
            ws.onerror = function(evt) {
                $('#conn_status').html('<b>Error</b>');
            }
            ws.onclose = function(evt) {
                $('#conn_status').html('<b>Closed</b>');
            }

            var pixel_size = 2;

            var init_grid = function(dim) {
                var newCanvas =
                    $('<canvas/>',{'class':'grid'})
                    .width(dim[0] * pixel_size)
                    .height(dim[0] * pixel_size);
                $('#placeholder').append(newCanvas);
            };

            var handle_msg = function(msg) {
                var data = JSON.parse(msg);
                var handle = handles;
                for (var ii in data) {
                    if (data[ii] in handle) {
                        handle = handle[data[ii]];
                        continue;
                    }
                    if (typeof(handle) === 'function') {
                        var args = data.slice(ii);
                        console.log('calling '+handle+' on ');
                        console.log(args);
                        handle.apply(undefined, args);
                        break;
                    }
                }
            };

            var handles = {
                'sim': {
                    'name': function(v) {$('#simname').html(v);},
                    'space': {
                        'grid': init_grid
                    },
                    'cell': draw_cell,
                },
                'step': function(v) {$('#stepnum').html(v);}
            };

            var draw_cell = function(index, param, value){

            };

        });
    </script>
    </head>
    <body>
        <h1 id='simname'>WebSocket Example</h1>
        <div id="conn_status">Not Connected</div>
        <div>
            <input type="button" id='step' value="step"/>
            <span id='stepnum'>0</span>
        </div>
        <div id="placeholder"></div>
        <script>
            $('#step').click(function(){ws.send("step");});
        </script>
    </body>
</html>
